---
title: "Med Gene List and Benchmark Gene Characterization"
date: '`r Sys.Date()`'
output: 
    bookdown::html_document2:
        toc: true
        toc_float: true
        df_print: paged
        code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(ggridges)
library(ggupset)
library(ggpubr)
```

# Objective
Generate figures for medically relevant genes benchmark manuscript with gene list characteristics.

Key points to address
- How well is the gene list covered by V4.
- What makes the genes by covered by V4 hard? showing different stratification overlaps
- Of the genes not covered by V4 how well are they covered by hifi asm?
- How well are the genes not covered by V4 covered by MRG?
- What is still not covered and why?

Gene Coverage/ overlap for
- V4.2.1 
- hifi asm dup
- putative SVs
- segmental duplications
- tandem repeats
- HG002 genes duplicated relative to GRCh38
- 50 bp V4 excluded regions
- CNVs
- seq tech coverage

# Approach
- Generate exploratory density/ histogram plots
- Create overview / summary figs

# Loading and tidying data
Input data tables generated with `analysis/tidying_data.Rmd`.
```{r}
## Gene source and testing modality information
mrg_info_tbl <- here("data","tidy","gene_list_info.tsv") %>% 
    read_tsv(col_types = "cccddcccllddddddd")

## Benchmark and Asm Coverage information
bench_asm_cov_df <- here("data","tidy","gene_asm_bench_coverage.tsv") %>% 
    read_tsv(col_types = "cccccddd")

## Difficult stratification coverage
strat_overlap_df <- here("data","tidy","gene_strat_overlap.tsv") %>% 
    read_tsv(col_types = "ccccd")
```


# Figures
## Gene Source
Gene source information - potentially use in place of an upset diagram.
```{r}
gene_list_df <- mrg_info_tbl %>% 
    ## Only plotting GRCh38 initially
    filter(ref == "GRCh38") %>% 
    pivot_longer(cols = c("mandelker","cosmic","high_priority"),
                 names_to = "gene_list") %>% 
    filter(value == "yes")

(gene_list_upset_plt <- gene_list_df %>% 
    group_by(ref, chrom, start, end, gene) %>%
    summarise(list_set = list(gene_list)) %>% 
    # distinct(title, year, length, .keep_all=TRUE) %>%
    ggplot(aes(x = list_set)) +
    geom_bar() +
    geom_text(stat='count', aes(label=after_stat(count)), vjust=-0.25) +
    scale_x_upset() + 
    scale_y_log10() + 
    annotation_logticks(sides = "lr") +
    theme_bw() +
    labs(x = "Gene List", y = "Number of Genes"))
```


## V4 Coverage
Most medically relevant genes are covered by V4 benchmark set. 
A number of genes with less than 90% coverage including >40 genes with no coverage.
__QUESTION:__ Is this the gene body + flank or gene body?

```{r}
(v4_cov_full_dist <- bench_asm_cov_df %>% 
    ## Excluding mito and sex chromosomes
    filter(ref == "GRCh38",
        str_detect(coords, "[MTXY]",negate = TRUE), 
           region == "gene", 
           benchmark == "v4") %>% 
    ggplot() +
    geom_histogram(aes(x = cov), 
                   fill = "grey80", color = "grey20",
                   size = 0.25, bins = 100) +
    theme_bw() + 
    labs(x = "Gene Coverage", y = "Number of Genes"))
```
Inset of coverage for genes with less than 90% coverage
_TODO_ Color by in MRG(stacked plot), use xlims instead of filter.

```{r}
v4_cov_df <- bench_asm_cov_df %>% 
    ## Excluding mito and sex chromosomes
    filter(ref == "GRCh38",
           str_detect(coords, "[MTXY]",negate = TRUE), 
           region == "gene") %>% 
     pivot_wider(id_cols = c("gene","ref","coords"), 
                 names_from = benchmark, values_from = cov)

n_cov_df <- v4_cov_df %>% 
    mutate(cov_lvl = if_else(v4 > 0.9, "high v4 cov", "low v4 cov")) %>% 
    count(ref, cov_lvl)

v4_low_cov_df <- bench_asm_cov_df %>% 
    ## Excluding mito and sex chromosomes
    filter(ref == "GRCh38",
           str_detect(coords, "[MTXY]",negate = TRUE), 
           region == "gene") %>% 
     pivot_wider(id_cols = c("gene","ref","coords"), 
                 names_from = benchmark, values_from = cov) %>% 
    filter(v4 < 0.9) %>% 
    mutate(benchmarked = if_else(mrg > 0, "in MRG","not in MRG"))
```
```{r}
n_cov_df
```



```{r}
n_high_v4_cov <- n_cov_df$n[n_cov_df$cov_lvl == "high v4 cov"]
n_low_v4_cov <- n_cov_df$n[n_cov_df$cov_lvl == "low v4 cov"]

(
    v4_cov_plt <- ggplot(v4_low_cov_df) +
        geom_histogram(
            aes(x = v4, fill = benchmarked),
            color = "grey20",
            size = 0.25,
            bins = 90
        ) +
        geom_text(aes(
            x = 0.05,
            y = 42,
            label = str_c(n_high_v4_cov,
                          " High Coverage Genes (not shown)"),
            hjust = 0
        )) +
        geom_text(aes(
            x = 0.05,
            y = 38,
            label = str_c(n_low_v4_cov, 
                          " Low Coverage Genes"),
            hjust = 0
        )) +
        theme_bw() +
        labs(x = "Gene Coverage by V4 Benchmark", y = "Number of Genes") +
        theme(legend.position = "bottom",
              legend.title = element_blank())
)
```


# Gene List Figure
```{r}
(gene_list_plt <- ggarrange(gene_list_upset_plt, v4_cov_plt, labels = "AUTO"))
```


```{r}
ggsave(here("figures","gene_list.png"),
       gene_list_plt, 
       width = 8, height = 6)
```




## ASM Coverage
Most of the medically relevant genes are fully covered by the hifi asm assembly.
```{r}
hifi_cov_df <- mrg_bench_asm_df %>% 
    ## Excluding mito and sex chromosomes
    filter(str_detect(coords, "[MTXY]",negate = TRUE),
           ref == "GRCh38",
           region == "gene", 
           benchmark == "hifi")

(n_cov_df <- hifi_cov_df %>% 
    mutate(cov_lvl = if_else(cov == 1, "fully", "not fully")) %>% 
    count(ref, cov_lvl))
```

```{r}
n_fully_covered <- n_cov_df %>% 
    filter(cov_lvl == "fully") %>% 
    {.$n} 

(hifi_cov_plt <- hifi_cov_df %>% 
    filter(cov != 1.0) %>% 
    ggplot() +
    geom_histogram(aes(x = cov), 
                   fill = "grey80", color = "grey20", size = 0.25, bins = 100) +
    geom_text(aes(x = 0.25, y = 34, 
                  label = str_c(n_fully_covered, " genes resolved in assembly (not shown)"))) + 
    theme_bw() + 
    labs(x = "Gene Coverage", y = "Number of Genes"))
```



## Difficult Strat Overlap
__TODO__ Update strat list - CNV union, all difficult, lowmap   
__QUESTION__ Which segdup to use


Annotating with benchmark membership info
```{r}
mrg_gene_cats <- bench_asm_cov_df %>% 
    filter(str_detect(coords, "[MTXY]",negate = TRUE),
           ref == "GRCh38",
           region == "gene") %>% 
    select(-vars, -svs) %>% 
    pivot_wider(names_from = benchmark, values_from = cov) %>% 
    mutate(gene_cat = case_when(mrg > 0 ~ "in_mrg",
                                v4 > 0.9 ~ "highV4",
                                v4 < 0.9 & hifi < 1 ~ "lowDip_lowV4",
                                mrg == 0 & hifi == 1 ~ "Excluded?",
                                TRUE ~ "???")
           )

mrg_gene_cats %>% count(gene_cat)
```

```{r}
diff_strat_plt_df <- strat_overlap_df %>%
    filter(str_detect(coords, "[MTXY]", negate = TRUE),
           ref == "GRCh38") %>%
    filter(
        strat %in% c(
            "lowmapAndSegDup",
            "segdupHiCntHiPct",
            "repeatsGt10kb",
            "giabSV",
            "outlierCNV"
        )
    ) %>% 
    left_join(mrg_gene_cats) %>% 
    select(-v4, -mrg, -hifi)
```

```{r}
diff_strat_plt_df %>% 
    filter(overlap > 0.09,
            gene_cat != "Excluded?") %>% 
    ggplot() + 
    geom_histogram(aes(x = overlap, fill = strat), 
                   color = "grey20",
                   size = 0.25,
                   position = "dodge",
                   binwidth = 0.25) + 
    facet_wrap(~gene_cat, ncol = 1, 
               # scales = "free_y"
               ) +
    theme_bw() + 
    theme(legend.position = "bottom")
```
```{r}
diff_strat_plt_df %>% 
    filter(overlap > 0.09,
            gene_cat != "Excluded?") %>% 
    ggplot() + 
    geom_histogram(aes(x = overlap, fill = gene_cat), 
                   color = "grey20", 
                   size = 0.25,
                   position = "dodge",
                   bins = 10) + 
    facet_wrap(~strat, ncol = 1, 
               # scales = "free_y"
               ) +
    theme_bw() + 
    theme(legend.position = "bottom")
```
Revise plot to show strat with max overlap per gene - alternatively use all difficult
```{r}
diff_strat_plt_df %>% 
    group_by(gene, coords, overlap) %>% 
    top_n(n = 1, wt = overlap) %>% 
    sample_n(size = 1) %>% 
    mutate(strat = if_else(overlap == 0, "NA", strat))
```

```{r}
diff_strat_plt_df
```



# Extra
### Why the uncovered genes are not covered
```{r}
v4_strat_plt_df <- bench_asm_cov_df %>% 
    ## Excluding mito and sex chromosomes
    filter(str_detect(coords, "[MTXY]",negate = TRUE), 
           region == "gene", 
           benchmark == "v4") %>%
    mutate(v4_cov_cat = case_when(cov > 0.9 ~ "gt90",
                                  cov > 0.75 ~ "gt75",
                                  cov > 0.5 ~ "gt50",
                                  cov > 0.25 ~"gt25",
                                  TRUE ~ "gt0")) %>% 
    left_join(mrg_strat_df)
```

TODO - revise strat list to address redundancy and cleanup 

Fig cap: Histogram of stratification overlap for genes with high and low V4 coverage.
Decrease in V4 coverage correlated with increasing stratificaiton coverage.
```{r}
## getting strat with most coverage by gene, randomly select strat when ties. 
high_low_v4 <- v4_strat_plt_df %>% 
    group_by(gene, coords, benchmark, region, cov,v4_cov_cat) %>% 
    top_n(n = 1, wt = value) %>% 
    sample_n(size = 1) %>% 
    mutate(strat = if_else(value == 0, "NA", strat))

high_low_v4 %>% 
    top_n(n = 1, wt = value) %>% 
    filter(v4_cov_cat != "high" | value != 0) %>% 
    ggplot() + 
    geom_histogram(aes(x = value, fill = strat), 
                   bins = 10, color = "grey40", size = 0.25) + 
    facet_grid(v4_cov_cat ~ ., scales = "free_y") + 
    theme_bw() + 
    theme(legend.position = "bottom")
```

3,557 genes with with > 90% v4 coverage are not overlapped by any stratification.  
170 genes with low v4 coverage are not overlapped by any stratification. 
Q - What are these genes? What makes them hard?

```{r}
high_low_v4 %>% 
    mutate(value = round(value, 1)) %>% 
    ungroup() %>% 
    count(v4_cov_cat, value) %>% 
    spread(v4_cov_cat, n, fill =  0)
```

```{r}
mrg_bench_asm_df %>% 
    filter(str_detect(coords, "[MTXY]",negate = TRUE)) %>% 
    filter(region == "gene") %>% 
    select(-vars, -svs) %>% 
    pivot_wider(names_from = benchmark, values_from = cov) %>%
    mutate(dbl_and = v4 < 1 | hifi < 1) %>% 
    filter(v4 < 1 | hifi < 1) %>%
    ggplot() +
    geom_hex(aes(x = v4, y = hifi)) +
    theme_bw()
```

```{r}
mrg_bench_asm_df %>% 
    filter(str_detect(coords, "[MTXY]",negate = TRUE)) %>% 
    filter(region == "gene", benchmark != "mrg") %>%  
    ggplot() + 
    geom_point(aes(x = benchmark, y = cov*100 + 1), alpha = 0.25) + 
    scale_y_log10()  + 
    theme_bw() + 
    labs(y = "Gene Coverage %") + 
    annotation_logticks(sides = "lr") 
```

Expect only genes in the medically relevant benchmark to have dip cov of 1 and v4 cov < 0.9. 
Table of genes not meeting these expectations.
Need to get definitions for different column values

Partially covered genes - potentially due to overlap with flanking regions from a different gene included in the medically relevant benchmark.
```{r}
mrg_bench_asm_df %>% 
    filter(region == "gene") %>% 
    select(-vars, -svs) %>% 
    pivot_wider(names_from = benchmark, values_from = cov) %>% 
    filter(mrg > 0, dip < 1)
```

Gene Categories - will need to update after getting column values definitions.
```{r}
mrg_gene_cats <- mrg_bench_asm_df %>% 
    filter(str_detect(coords, "[MTXY]",negate = TRUE)) %>% 
    filter(region == "gene") %>% 
    select(-vars, -svs) %>% 
    pivot_wider(names_from = benchmark, values_from = cov) %>% 
    mutate(gene_cat = case_when(mrg > 0 ~ "in_mrg",
                                v4 > 0.9 ~ "highV4",
                                v4 < 0.9 & hifi < 1 ~ "lowDip_lowV4",
                                mrg == 0 & hifi == 1 ~ "Excluded?",
                                TRUE ~ "???")
           )
```

```{r}
mrg_gene_cats %>%
    count(gene_cat)
```

```{r}
mrg_gene_cats %>%
    filter(gene_cat == "Excluded?")
```


### Stratification analysis of gene coverage
```{r}
strat_plt_df <- mrg_strat_df %>% 
    right_join(mrg_gene_cats)
```
Genes in the excluded? gene cat are primarily excluded due to overlap with assembly based CNV set. 
```{r}
strat_plt_df %>% 
    filter(strat %in% c("repeatsGt10kb", "asmCNV", 
                        "giabSV", "lowmapAndSegDup"),
           value != 0) %>% 
    ggplot() + 
         geom_density_ridges(aes(x = value, y = gene_cat),
                             stat = "binline", bins = 50, 
                             scale = 0.95, draw_baseline = FALSE) +
    facet_wrap(~strat, scales = "free") +
        theme_bw() + 
    labs(x = "Gene Coverage", y = "Gene Category")
```

#### CNV strats
```{r}
strat_plt_df %>% 
    filter(str_detect(strat, "CNV")) %>%
    ggplot() + 
         geom_density_ridges(aes(x = value, y = gene_cat),
                             stat = "binline", bins = 50, 
                             scale = 0.95, draw_baseline = FALSE) +
    facet_wrap(~strat, scales = "free", ncol = 1) +
        theme_bw() + 
    labs(x = "Gene Coverage", y = "Gene Category")
```
```{r}
strat_plt_df %>% 
    filter(str_detect(strat, "CNV"), value != 0) %>%
    ggplot() + 
         geom_density_ridges(aes(x = value, y = gene_cat),
                             stat = "binline", bins = 50, 
                             scale = 0.95, draw_baseline = FALSE) +
    facet_wrap(~strat, scales = "free") +
        theme_bw() + 
    labs(x = "Gene Coverage", y = "Gene Category")
```

### Segmental Duplications and Large Repeats
```{r}
strat_plt_df %>% 
    filter(str_detect(strat, ".eg.up") | 
           strat == "repeatsGt10kb") %>% # Case insensitive segdup
    ggplot() + 
         geom_density_ridges(aes(x = value, y = gene_cat),
                             stat = "binline", bins = 50, 
                             scale = 0.95, draw_baseline = FALSE) +
    facet_wrap(~strat, scales = "free") +
        theme_bw() + 
    labs(x = "Gene Coverage", y = "Gene Category")
```


```{r}
strat_plt_df %>% 
    filter(str_detect(strat, ".eg.up") | 
           strat == "repeatsGt10kb",
           value != 0) %>%
    ggplot() + 
         geom_density_ridges(aes(x = value, y = gene_cat),
                             stat = "binline", bins = 50, 
                             scale = 0.95, draw_baseline = FALSE) +
    facet_wrap(~strat) +
        theme_bw() + 
    labs(x = "Gene Coverage", y = "Gene Category")
```
```{r}
strat_plt_df$strat %>% unique()
```

### Other Strats
```{r}
other_strats <- c("refn","vdj", "inversion")
strat_plt_df %>% 
    filter(strat %in% other_strats) %>%
    ggplot() + 
    geom_histogram(aes(x = value, fill = gene_cat), bins = 50) + 
    facet_grid(gene_cat~strat, scales = "free_y") +
        theme_bw() + 
    labs(x = "Gene Coverage", y = "Gene Category")
```
```{r}
other_strats <- c("refn","vdj", "inversion")
strat_plt_df %>% 
    filter(strat %in% other_strats, value > 0) %>%
    ggplot() + 
    geom_histogram(aes(x = value, fill = gene_cat), bins = 50) + 
    facet_grid(gene_cat~strat, scales = "free_y") +
        theme_bw() + 
    labs(x = "Gene Coverage", y = "Gene Category")
```

### Excluded Genes
High coverage for segdups and CNV??
```{r}
strat_plt_df %>%
    filter(gene_cat == "Excluded?") %>% 
    pivot_wider(names_from = strat, values_from = value)
```

# Session Information
## System Information
```{r}
sessioninfo::platform_info()
```


## Package Versions
```{r}
sessioninfo::package_info() %>% 
    filter(attached = TRUE) %>% 
    select(package, loadedversion, date, source) %>%
    knitr::kable(booktabs = TRUE, row.names = FALSE)
```